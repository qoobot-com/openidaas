# ============================================================================
# OpenIDaaS ConfigMap
# ============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: openidaas-config
  namespace: openidaas
data:
  # Application configuration
  application.yml: |
    spring:
      application:
        name: openidaas
      profiles:
        active: prod
      datasource:
        url: ${DATABASE_URL:jdbc:postgresql://postgres-service:5432/openidaas}
        username: ${DATABASE_USERNAME:openidaas}
        password: ${DATABASE_PASSWORD}
        hikari:
          maximum-pool-size: 20
          minimum-idle: 5
          connection-timeout: 30000
          idle-timeout: 600000
          max-lifetime: 1800000
      data:
        redis:
          host: ${REDIS_HOST:redis-service}
          port: 6379
          password: ${REDIS_PASSWORD}
          timeout: 3000
          lettuce:
            pool:
              max-active: 8
              max-idle: 8
              min-idle: 0
              max-wait: -1ms

    openidaas:
      enabled: true
      auth:
        enabled: true
        jwt:
          enabled: true
          secret: ${JWT_SECRET}
          expiration: 3600
          refresh-expiration: 2592000
      security:
        enabled: true
        password-policy:
          min-length: 8
          max-length: 128
          require-uppercase: true
          require-lowercase: true
          require-numbers: true
          require-special-chars: true
        mfa:
          enabled: false
        rate-limit:
          enabled: true
          algorithm: TOKEN_BUCKET
          requests-per-minute: 100
      tenant:
        enabled: true
        isolation-strategy: SCHEMA
      monitoring:
        enabled: true
        metrics-enabled: true
        audit-enabled: true
        health-check-enabled: true

    management:
      endpoints:
        web:
          exposure:
            include: health,info,metrics,prometheus
          base-path: /actuator
      endpoint:
        health:
          show-details: when-authorized
          probes:
            enabled: true
      metrics:
        export:
          prometheus:
            enabled: true
        tags:
          application: ${spring.application.name}

  # Logging configuration
  logback.xml: |
    <configuration>
      <springProperty scope="context" name="APP_NAME" source="spring.application.name"/>
      <property name="LOG_PATH" value="/app/logs"/>
      <property name="LOG_PATTERN"
                value="%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"/>

      <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
          <pattern>${LOG_PATTERN}</pattern>
        </encoder>
      </appender>

      <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_PATH}/${APP_NAME}.log</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
          <fileNamePattern>${LOG_PATH}/${APP_NAME}.%d{yyyy-MM-dd}.%i.log</fileNamePattern>
          <maxHistory>30</maxHistory>
          <timeBasedFileNamingAndTriggeringPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP">
            <maxFileSize>100MB</maxFileSize>
          </timeBasedFileNamingAndTriggeringPolicy>
        </rollingPolicy>
        <encoder>
          <pattern>${LOG_PATTERN}</pattern>
        </encoder>
      </appender>

      <root level="INFO">
        <appender-ref ref="CONSOLE"/>
        <appender-ref ref="FILE"/>
      </root>

      <logger name="com.qoobot.openidaas" level="DEBUG"/>
      <logger name="org.springframework" level="INFO"/>
      <logger name="org.springframework.security" level="DEBUG"/>
    </configuration>

  # Nginx configuration
  nginx.conf: |
    upstream auth-service {
      least_conn;
      server openidaas-auth:8080;
      keepalive 32;
    }

    upstream user-service {
      least_conn;
      server openidaas-user:8080;
      keepalive 32;
    }

    upstream gateway-service {
      least_conn;
      server openidaas-gateway:8080;
      keepalive 32;
    }

    server {
      listen 80;
      server_name _;

      location /health {
        return 200 "healthy\n";
        add_header Content-Type text/plain;
      }

      location /auth/ {
        proxy_pass http://auth-service/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
      }

      location /api/ {
        proxy_pass http://gateway-service/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
      }
    }

# 测试环境配置
server:
  port: 8080
  shutdown: graceful

spring:
  profiles:
    active: test

  cloud:
    gateway:
      routes:
        # ==================== v1 版本路由 ====================

        # 认证服务 v1
        - id: auth-service-v1
          uri: lb://openidaas-auth-service
          predicates:
            - Path=/api/v1/auth/**
          filters:
            - StripPrefix=2
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 50
                redis-rate-limiter.burstCapacity: 100
                key-resolver: "#{@ipKeyResolver}"

        # 用户服务 v1
        - id: user-service-v1
          uri: lb://openidaas-user-service
          predicates:
            - Path=/api/v1/users/**
          filters:
            - StripPrefix=2
            - name: JwtAuthentication
              args:
                requireAuth: true

        # 组织服务 v1
        - id: organization-service-v1
          uri: lb://openidaas-organization-service
          predicates:
            - Path=/api/v1/organizations/**
          filters:
            - StripPrefix=2
            - name: JwtAuthentication
              args:
                requireAuth: true

        # 角色服务 v1
        - id: role-service-v1
          uri: lb://openidaas-role-service
          predicates:
            - Path=/api/v1/roles/**
          filters:
            - StripPrefix=2
            - name: JwtAuthentication
              args:
                requireAuth: true

        # 应用服务 v1
        - id: application-service-v1
          uri: lb://openidaas-application-service
          predicates:
            - Path=/api/v1/applications/**
          filters:
            - StripPrefix=2
            - name: JwtAuthentication
              args:
                requireAuth: true

        # 审计服务 v1
        - id: audit-service-v1
          uri: lb://openidaas-audit-service
          predicates:
            - Path=/api/v1/audit/**
          filters:
            - StripPrefix=2
            - name: JwtAuthentication
              args:
                requireAuth: true

      # 全局CORS配置
      globalcors:
        cors-configurations:
          '[/**]':
            allowed-origins: "*"
            allowed-methods: "*"
            allowed-headers: "*"
            allow-credentials: true
            max-age: 3600

  # Redis 配置
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      database: ${REDIS_DB:1}
      lettuce:
        pool:
          max-active: 10
          max-wait: -1ms
          max-idle: 10
          min-idle: 2
      timeout: 3000ms

# Actuator 配置
management:
  endpoints:
    web:
      exposure:
        include: health,info,gateway
  endpoint:
    health:
      show-details: always
  metrics:
    tags:
      environment: test
      application: ${spring.application.name}

# 日志配置
logging:
  level:
    root: INFO
    com.qoobot.openidaas: DEBUG
    org.springframework.cloud.gateway: INFO
    org.springframework.web: INFO
  pattern:
    console: '%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level [%X{traceId:-N/A}] %logger{36} - %msg%n'
  file:
    name: logs/openidaas-gateway-test.log

# 测试环境特性
spring.devtools.restart.enabled: false

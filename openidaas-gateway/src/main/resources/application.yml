server:
  port: 8080
  shutdown: graceful

spring:
  application:
    name: openidaas-gateway
  profiles:
    active: dev
  cloud:
    nacos:
      discovery:
        server-addr: ${NACOS_SERVER_ADDR:localhost:8848}
        namespace: ${NACOS_NAMESPACE:public}
        group: IDaaS_GROUP
      config:
        server-addr: ${NACOS_SERVER_ADDR:localhost:8848}
        namespace: ${NACOS_NAMESPACE:public}
        group: IDaaS_GROUP
        file-extension: yml

    gateway:
      discovery:
        locator:
          enabled: true
          lower-case-service-id: true

      routes:
        # ==================== API 路由 ====================

        # 认证服务
        - id: auth-service
          uri: lb://openidaas-auth-service
          predicates:
            - Path=/api/auth/**
          filters:
            - StripPrefix=2
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 100
                redis-rate-limiter.burstCapacity: 200
                key-resolver: "#{@ipKeyResolver}"

        # 用户服务
        - id: user-service
          uri: lb://openidaas-user-service
          predicates:
            - Path=/api/users/**
          filters:
            - StripPrefix=2
            - name: JwtAuthentication
              args:
                requireAuth: true

        # 组织服务
        - id: organization-service
          uri: lb://openidaas-organization-service
          predicates:
            - Path=/api/organizations/**
          filters:
            - StripPrefix=2
            - name: JwtAuthentication
              args:
                requireAuth: true

        # 角色服务
        - id: role-service
          uri: lb://openidaas-role-service
          predicates:
            - Path=/api/roles/**
          filters:
            - StripPrefix=2
            - name: JwtAuthentication
              args:
                requireAuth: true

        # 应用服务
        - id: application-service
          uri: lb://openidaas-application-service
          predicates:
            - Path=/api/applications/**
          filters:
            - StripPrefix=2
            - name: JwtAuthentication
              args:
                requireAuth: true

        # 审计服务
        - id: audit-service
          uri: lb://openidaas-audit-service
          predicates:
            - Path=/api/audit/**
          filters:
            - StripPrefix=2
            - name: JwtAuthentication
              args:
                requireAuth: true

        # 授权服务
        - id: authorization-service
          uri: lb://openidaas-authorization-service
          predicates:
            - Path=/api/authorization/**
          filters:
            - StripPrefix=2
            - name: JwtAuthentication
              args:
                requireAuth: true

      # 全局CORS配置
      globalcors:
        cors-configurations:
          '[/**]':
            allowed-origins: "*"
            allowed-methods: "*"
            allowed-headers: "*"
            allow-credentials: true
            max-age: 3600

      # 默认过滤器
      default-filters:
        - DedupeResponseHeader=Access-Control-Allow-Credentials Access-Control-Allow-Origin
        - SaveSession

  # Redis配置
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      database: ${REDIS_DB:0}
      lettuce:
        pool:
          max-active: 8
          max-wait: -1ms
          max-idle: 8
          min-idle: 0
      timeout: 3000ms

# Sentinel配置
spring.cloud.sentinel:
  # 启用 Sentinel
  enabled: true
  # 传输配置
  transport:
    dashboard: ${SENTINEL_DASHBOARD:localhost:8858}
    port: 8719
    client-ip: ${SENTINEL_CLIENT_IP:}
  # 服务名称
  application: ${spring.application.name}
  # 心跳配置
  heartbeat:
    client-ip: ${SENTINEL_CLIENT_IP:}
  # 数据源
  datasource:
    # 文件数据源
    file:
      enabled: true
      file: classpath:sentinel/rules.json
      rule-type: flow
    # Nacos 数据源
    nacos:
      enabled: true
      server-addr: ${NACOS_SERVER_ADDR:localhost:8848}
      namespace: ${NACOS_NAMESPACE:public}
      group-id: SENTINEL_GROUP
      rule-type: flow
      data-id: ${spring.application.name}-flow-rules
  # 流控规则
  filter:
    enabled: true
  # 网关配置
  scg:
    enabled: true
    order: 100

# 网关特定 Sentinel 配置
spring.cloud.sentinel.scg.fallback:
  # 响应模式
  response-mode: response
  # 响应状态码
  response-status: 429
  # 响应内容
  response-body: '{"code": 429, "message": "系统繁忙，请稍后重试"}'

# 自定义 Sentinel 配置
sentinel:
  # 是否启用
  enabled: true
  # 流控配置
  flow:
    # 默认 QPS
    qps: 200
    # 限流行为: 0-直接拒绝, 1-Warm Up, 2-匀速排队
    control-behavior: 0
    # Warm Up 周期（秒）
    warm-up-period: 10
  # 降级配置
  degrade:
    # 降级比例
    ratio: 0.5
    # 降级时间窗口（秒）
    time-window: 10
    # 慢调用比例阈值
    slow-ratio: 0.5
    # 慢调用 RT 阈值（毫秒）
    slow-rt: 500
    # 最小请求数
    min-request: 5
    # 统计时间窗口（秒）
    stat-interval: 1

# Actuator配置
management:
  endpoints:
    web:
      exposure:
        include: health,info,gateway
  endpoint:
    health:
      show-details: always

# 日志配置
logging:
  level:
    root: INFO
    com.qoobot.openidaas: DEBUG
    org.springframework.cloud.gateway: DEBUG
  pattern:
    console: '%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level [%X{traceId:-N/A}] %logger{36} - %msg%n'

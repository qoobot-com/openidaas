# 生产环境配置
server:
  port: 8080
  shutdown: graceful

spring:
  profiles:
    active: prod

  cloud:
    gateway:
      routes:
        # ==================== v1 版本路由 ====================

        # 认证服务 v1
        - id: auth-service-v1
          uri: lb://openidaas-auth-service
          predicates:
            - Path=/api/v1/auth/**
          filters:
            - StripPrefix=2
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 200
                redis-rate-limiter.burstCapacity: 400
                key-resolver: "#{@ipKeyResolver}"

        # 用户服务 v1
        - id: user-service-v1
          uri: lb://openidaas-user-service
          predicates:
            - Path=/api/v1/users/**
          filters:
            - StripPrefix=2
            - name: JwtAuthentication
              args:
                requireAuth: true

        # 组织服务 v1
        - id: organization-service-v1
          uri: lb://openidaas-organization-service
          predicates:
            - Path=/api/v1/organizations/**
          filters:
            - StripPrefix=2
            - name: JwtAuthentication
              args:
                requireAuth: true

        # 角色服务 v1
        - id: role-service-v1
          uri: lb://openidaas-role-service
          predicates:
            - Path=/api/v1/roles/**
          filters:
            - StripPrefix=2
            - name: JwtAuthentication
              args:
                requireAuth: true

        # 应用服务 v1
        - id: application-service-v1
          uri: lb://openidaas-application-service
          predicates:
            - Path=/api/v1/applications/**
          filters:
            - StripPrefix=2
            - name: JwtAuthentication
              args:
                requireAuth: true

        # 审计服务 v1
        - id: audit-service-v1
          uri: lb://openidaas-audit-service
          predicates:
            - Path=/api/v1/audit/**
          filters:
            - StripPrefix=2
            - name: JwtAuthentication
              args:
                requireAuth: true

        # ==================== v2 版本路由（预留） ====================

        # 认证服务 v2（未来版本）
        - id: auth-service-v2
          uri: lb://openidaas-auth-service
          predicates:
            - Path=/api/v2/auth/**
          filters:
            - StripPrefix=2
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 200
                redis-rate-limiter.burstCapacity: 400
                key-resolver: "#{@ipKeyResolver}"

        # 用户服务 v2（未来版本）
        - id: user-service-v2
          uri: lb://openidaas-user-service
          predicates:
            - Path=/api/v2/users/**
          filters:
            - StripPrefix=2
            - name: JwtAuthentication
              args:
                requireAuth: true

      # 全局CORS配置
      globalcors:
        cors-configurations:
          '[/**]':
            allowed-origins: ${CORS_ALLOWED_ORIGINS:https://your-domain.com}
            allowed-methods: "GET,POST,PUT,DELETE,OPTIONS"
            allowed-headers: "*"
            allow-credentials: true
            max-age: 3600

      # 默认过滤器
      default-filters:
        - DedupeResponseHeader=Access-Control-Allow-Credentials Access-Control-Allow-Origin
        - SaveSession

  # Redis 配置
  data:
    redis:
      host: ${REDIS_HOST}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD}
      database: ${REDIS_DB:0}
      lettuce:
        pool:
          max-active: 20
          max-wait: -1ms
          max-idle: 10
          min-idle: 5
        shutdown-timeout: 200ms
      timeout: 5000ms
      ssl: false

# Actuator 配置
management:
  endpoints:
    web:
      exposure:
        include: health,info,gateway
      base-path: /actuator
  endpoint:
    health:
      show-details: never
  metrics:
    tags:
      environment: prod
      application: ${spring.application.name}
      region: ${REGION:default}

# 日志配置
logging:
  level:
    root: WARN
    com.qoobot.openidaas: INFO
    org.springframework.cloud.gateway: WARN
    org.springframework.web: WARN
  pattern:
    console: '%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level [%X{traceId:-N/A}] %logger{36} - %msg%n'
    file: '%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level [%X{traceId:-N/A}] %logger{36} - %msg%n'
  file:
    name: /var/log/openidaas/openidaas-gateway.log
    max-size: 100MB
    max-history: 30
    total-size-cap: 1GB

# 生产环境特性
spring.devtools.restart.enabled: false
spring.servlet.multipart.max-file-size: 10MB
spring.servlet.multipart.max-request-size: 10MB

version: '3.8'

services:
  # MySQL 数据库
  mysql:
    image: mysql:9.1
    container_name: openidaas-mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root123456}
      MYSQL_DATABASE: openidaas
      MYSQL_USER: openidaas
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-openidaas123}
    ports:
      - "3306:3306"
    volumes:
      - mysql-data:/var/lib/mysql
      - ./db/schema.sql:/docker-entrypoint-initdb.d/01-schema.sql
      - ./db/mfa_schema.sql:/docker-entrypoint-initdb.d/02-mfa.sql
      - ./db/audit_schema.sql:/docker-entrypoint-initdb.d/03-audit.sql
      - ./db/application_schema.sql:/docker-entrypoint-initdb.d/04-application.sql
      - ./db/nacos-schema.sql:/docker-entrypoint-initdb.d/05-nacos.sql
    networks:
      - openidaas-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD:-root123456}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis 缓存
  redis:
    image: redis:7-alpine
    container_name: openidaas-redis
    command: redis-server --requirepass ${REDIS_PASSWORD:-redis123456}
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - openidaas-network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Nacos 服务注册与配置中心
  nacos:
    image: nacos/nacos-server:v2.3.2
    container_name: openidaas-nacos
    environment:
      MODE: standalone
      SPRING_DATASOURCE_PLATFORM: mysql
      MYSQL_SERVICE_HOST: mysql
      MYSQL_SERVICE_PORT: 3306
      MYSQL_SERVICE_DB_NAME: nacos_config
      MYSQL_SERVICE_USER: root
      MYSQL_SERVICE_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root123456}
      NACOS_AUTH_ENABLE: true
      NACOS_AUTH_TOKEN: ${NACOS_AUTH_TOKEN:-SecretKey012345678901234567890123456789012345678901234567890123456789}
      JVM_XMS: 512m
      JVM_XMX: 512m
    ports:
      - "8848:8848"
      - "9848:9848"
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - openidaas-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8848/nacos/"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Sentinel 流量控制
  sentinel:
    image: bladex/sentinel-dashboard:1.8.6
    container_name: openidaas-sentinel
    ports:
      - "8858:8858"
    networks:
      - openidaas-network

  # 网关服务
  gateway:
    build:
      context: ../../../openidaas-gateway
      dockerfile: ../../openidaas-gateway/Dockerfile
    container_name: openidaas-gateway
    environment:
      SPRING_PROFILES_ACTIVE: docker
      NACOS_SERVER_ADDR: nacos:8848
      NACOS_AUTH_TOKEN: ${NACOS_AUTH_TOKEN:-SecretKey012345678901234567890123456789012345678901234567890123456789}
    ports:
      - "8080:8080"
    depends_on:
      nacos:
        condition: service_healthy
    networks:
      - openidaas-network
    restart: unless-stopped

  # 认证服务
  auth-service:
    build:
      context: ../../../openidaas-auth-service
      dockerfile: ../../openidaas-auth-service/Dockerfile
    container_name: openidaas-auth-service
    environment:
      SPRING_PROFILES_ACTIVE: docker
      NACOS_SERVER_ADDR: nacos:8848
      MYSQL_HOST: mysql
      REDIS_HOST: redis
      REDIS_PASSWORD: ${REDIS_PASSWORD:-redis123456}
    depends_on:
      nacos:
        condition: service_healthy
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - openidaas-network
    restart: unless-stopped

  # 用户服务
  user-service:
    build:
      context: ../../../openidaas-user-service
      dockerfile: ../../openidaas-user-service/Dockerfile
    container_name: openidaas-user-service
    environment:
      SPRING_PROFILES_ACTIVE: docker
      NACOS_SERVER_ADDR: nacos:8848
      MYSQL_HOST: mysql
      REDIS_HOST: redis
      REDIS_PASSWORD: ${REDIS_PASSWORD:-redis123456}
    depends_on:
      nacos:
        condition: service_healthy
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - openidaas-network
    restart: unless-stopped

  # 组织服务
  organization-service:
    build:
      context: ../../../openidaas-organization-service
      dockerfile: ../../openidaas-organization-service/Dockerfile
    container_name: openidaas-organization-service
    environment:
      SPRING_PROFILES_ACTIVE: docker
      NACOS_SERVER_ADDR: nacos:8848
      MYSQL_HOST: mysql
      REDIS_HOST: redis
      REDIS_PASSWORD: ${REDIS_PASSWORD:-redis123456}
    depends_on:
      nacos:
        condition: service_healthy
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - openidaas-network
    restart: unless-stopped

  # 角色服务
  role-service:
    build:
      context: ../../../openidaas-role-service
      dockerfile: ../../openidaas-role-service/Dockerfile
    container_name: openidaas-role-service
    environment:
      SPRING_PROFILES_ACTIVE: docker
      NACOS_SERVER_ADDR: nacos:8848
      MYSQL_HOST: mysql
      REDIS_HOST: redis
      REDIS_PASSWORD: ${REDIS_PASSWORD:-redis123456}
    depends_on:
      nacos:
        condition: service_healthy
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - openidaas-network
    restart: unless-stopped

  # 应用服务
  application-service:
    build:
      context: ../../../openidaas-application-service
      dockerfile: ../../openidaas-application-service/Dockerfile
    container_name: openidaas-application-service
    environment:
      SPRING_PROFILES_ACTIVE: docker
      NACOS_SERVER_ADDR: nacos:8848
      MYSQL_HOST: mysql
      REDIS_HOST: redis
      REDIS_PASSWORD: ${REDIS_PASSWORD:-redis123456}
    depends_on:
      nacos:
        condition: service_healthy
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - openidaas-network
    restart: unless-stopped

  # 审计服务
  audit-service:
    build:
      context: ../../../openidaas-audit-service
      dockerfile: ../../openidaas-audit-service/Dockerfile
    container_name: openidaas-audit-service
    environment:
      SPRING_PROFILES_ACTIVE: docker
      NACOS_SERVER_ADDR: nacos:8848
      MYSQL_HOST: mysql
      REDIS_HOST: redis
      REDIS_PASSWORD: ${REDIS_PASSWORD:-redis123456}
    depends_on:
      nacos:
        condition: service_healthy
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - openidaas-network
    restart: unless-stopped

  # 前端 UI
  admin-ui:
    build:
      context: ../../../openidaas-admin-ui
      dockerfile: ../../openidaas-admin-ui/Dockerfile
    container_name: openidaas-admin-ui
    ports:
      - "80:80"
    depends_on:
      - gateway
    networks:
      - openidaas-network
    restart: unless-stopped

volumes:
  mysql-data:
  redis-data:

networks:
  openidaas-network:
    driver: bridge
